<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Matrix Demo</title>
    <link href="/stylesheets/qunit.css" media="all" rel="stylesheet" type="text/css"/><link href="/stylesheets/application.css" media="all" rel="stylesheet" type="text/css"/>
    <script language="javascript" src="javascripts/jquery-1.4.2.min.js" type="text/javascript"></script><script language="javascript" src="javascripts/matrix.js" type="text/javascript"></script>
  </head>
  <body>
    <div id='title'>
      <h1>Matrix Test</h1>
    </div>
    <div id='game_container'>
      <canvas height='480' id='gameCanvas' width='640'>
        <p>
          HTML5 canvas not supported by your browser.
          <a href="http://www.google.com/chrome">Learn more here</a>
        </p>
      </canvas>
    </div>
    <style>
      #gameCanvas {
        cursor: default; }
    </style>
    <script type='text/javascript'>
      //<![CDATA[
        /**
         * Creates a Sprite from an Image object.
         *
         * If called with just the image argument creates one sprite for the entire
         * image.
         *
         * Optional sourceX, sourceY arguments set where to start the sprite in the
         * image, default is 0,0
         *
         * Optional width, height set how big the sprite shoud be,
         * default is image.width, image.height
         */
        function Sprite(image, sourceX, sourceY, width, height) {
          sourceX = sourceX || 0;
          sourceY = sourceY || 0;
          width = width || image.width;
          height = height || image.height;
        
          return {
            // Draws the sprite centered at x, y
            draw: function(canvas, x, y) {
              canvas.drawImage(image,
                sourceX,
                sourceY,
                width,
                height,
                (x || 0) - width / 2,
                (y || 0) - height / 2,
                width,
                height
              );
            }
          };
        };
        
        function SpriteProxy() {
          return {
            draw: $.noop
          };
        }
        
        Sprite.load = function(url) {
          var img = new Image();
          var proxy = SpriteProxy();
        
          img.onload = function() {
            var sprite = Sprite(this);
        
            $.extend(proxy, sprite);
          };
        
          img.src = url;
        
          return proxy;
        };
        
        var transform = Matrix();
        
        var canvas = $('#gameCanvas').get(0).getContext('2d');
        
        $.extend(canvas, {
          withTransform: function(matrix, block) {
            this.save();
        
            this.transform(
              matrix.a,
              matrix.b,
              matrix.c,
              matrix.d,
              matrix.tx,
              matrix.ty
            );
        
            try {
              block();
            } finally {
              this.restore();
            }
          },
        
          fill: function(color) {
            this.fillStyle = color;
            this.fillRect(0, 0, 640, 480);
          }
        });
        
        function GameObject(imageUrl, transform, components) {
          var transform = transform || Matrix.IDENTITY;
        
          var self = {
            components: components || [],
            draw: function() {
              canvas.withTransform(self.transform(), function() {
                self.sprite.draw(canvas);
        
                $.each(self.components, function(i, component) {
                  component.draw(canvas);
                });
              });
            },
            transform: function(newTransform) {
              if(newTransform !== undefined) {
                transform = newTransform;
                return self;
              } else {
                return transform;
              }
            },
        
            // Rotate about the midpoint
            rotate: function(theta) {
              transform = transform.rotate(theta, Point(transform.tx, transform.ty));
            },
        
            // Move
            translate: function(tx, ty) {
              transform = transform.translate(tx, ty);
            },
        
            sprite: Sprite.load(imageUrl)
          };
        
          return self;
        }
        
        var hat = GameObject("images/accessories/tophat.png", Matrix.translation(30, -32));
        
        var dino = GameObject("images/levels/dino1.png", Matrix.translation(320, 240), [
          hat
        ]);
        
        setInterval(function() {
          canvas.fill('#A2EEFF');
        
          dino.draw(canvas);
        
        }, 33);
      //]]>
    </script>
    <script type="text/javascript">
    
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-3464282-10']);
      _gaq.push(['_trackPageview']);
    
      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    
    </script>
  </body>
</html>
