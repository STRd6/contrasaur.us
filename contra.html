<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>contra</title>
  <meta name="generator" content="TextMate http://macromates.com/">
  <meta name="author" content="Matthew Diebolt">
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
  <script src="javascripts/power_canvas.jquery.js"></script>
  <script src="javascripts/sprites.strd6.js"></script>
  <script src="javascripts/util.js"></script>
  <script src="javascripts/contrasaurus/bomb.js"></script>
  <script src="javascripts/contrasaurus/bomber.js"></script>
  <script src="javascripts/contrasaurus/bullet.js"></script>
  <script src="javascripts/contrasaurus/dinosaur.js"></script>
  <script src="javascripts/contrasaurus/enemy.js"></script>
  <script src="javascripts/contrasaurus/floor.js"></script>
  <script src="javascripts/contrasaurus/game_object.js"></script>
  <script src="javascripts/contrasaurus/level.js"></script>
  <script src="javascripts/contrasaurus/missile.js"></script>
  <script src="javascripts/contrasaurus/mortar.js"></script>
  <script src="javascripts/contrasaurus/powerup.js"></script>
  <script src="javascripts/contrasaurus/powerup_container.js"></script>
  <script src="javascripts/contrasaurus/tank.js"></script>
  <script src="javascripts/contrasaurus/UI.js"></script>

  
  <!-- Date: 2010-05-08 -->
</head>
<body>

  <canvas id="gameCanvas" width="640" height="480">
    <p> Get a better browser</p>
  </canvas>

  <audio src="audio/Dragon Force - My Spirit Will Go On.mp3" autoplay="true">
    Your browser does not support the audio element.
  </audio>

  <script>
  var score = 0;
  var canvas;
  var dino;
  var floor;
  var bulletTile = loadImageTile("images/blast_small.png");
  var dinoTile = loadImageTile("images/dino1.png");
  var tankTile = loadImageTile("images/tank.png");
  var bulletQueue = [];
  var dialogBox = DialogBox("GAME OVER");
  var currentLevel;
  var displayTexts = [];

  function shoot(bullet) {
    currentLevel.shoot(bullet);
  }

  function enemyShoot(bullet) {
    currentLevel.enemyShoot(bullet);
  }
  
  function display(text) {
    displayTexts.push(GameText(text, dino.boundingBox()));
  }

  function generateEnemies(enemies) {
    if (Math.random() < 0.005) {
      enemies.push(PowerupContainer(Math.PI / 2));
    }

    if (Math.random() < 0.03) {
      enemies.push(Enemy());
    }

    if (Math.random() < 0.01) {
      enemies.push(Tank({sprite: tankTile}));
    }

    if (Math.random() < 0.015) {
      enemies.push(Bomber({
        x: 600,
        y: 40
      }));
    }

    if (Math.random() < 0.01) {
      // HAX: Putting this in enemy bullets so it will collide with dino.
      enemyShoot(Powerup({
        x: rand(canvas.width()),
        yVelocity: 2
      }));
    }
  }

  $('#gameCanvas').powerCanvas({init: function(_canvas) {
    function drawOverlay() {
      var activeTexts = [];
      $.each(displayTexts, function(i, displayText) {
        //TODO: Move update out of draw
        displayText.update();

        if(displayText.active()) {
          displayText.draw(canvas);
          activeTexts.push(displayText);
        }
      });
      displayTexts = activeTexts;

      healthBar.value(dino.health());
      healthBar.draw(canvas);

      canvas.fillColor("#000");
      canvas.fillText("Health: ", 10, 14);

      // Score display
      canvas.fillText("Score: " + score, 225, 14);
    }

    canvas = _canvas;
    canvas.font("bold 1em consolas, 'Courier New', 'andale mono', 'lucida console', monospace");

    dino = Dinosaur()
    floor = Floor();

    var scene = Scene([
      {
        image: loadImageTile("images/mountains.png"),
        position: {
          x: 0,
          y: 0
        }
      },
      {
        image: loadImageTile("images/fire.png"),
        position: {
          x: 640,
          y: 0
        }
      },
      {
        image: loadImageTile("images/clouds2.png"),
        rate: {x: -0.5},
        position: {
          x: 0,
          y: 0
        },
        repeat: true
      },
      {
        image: loadImageTile("images/clouds1.png"),
        rate: {x: -1},
        position: {
          x: 0,
          y: 0
        },
        repeat: true
      }
    ], [
      {
        image: loadImageTile('images/jungleTree.png'),
        position: {
          x: rand(canvas.width() - 116),
          y: canvas.height() - floor.boundingBox().height + 10 + rand(floor.boundingBox().height - 10) - 160,
        }
      },
      {
        image: loadImageTile('images/jungleTree.png'),
        position: {
          x: rand(canvas.width() - 116),
          y: canvas.height() - floor.boundingBox().height + 10 + rand(floor.boundingBox().height - 10) - 160,
        }
      }
    ]);
  
    var healthBar = ProgressBar({
      colorMap: healthColorMap,
      max: dino.health(),
      value: dino.health(),
      x: 85,
      y: 4,
      width: 100,
      height: 14
    });

    var level1 = Level(canvas, dino, scene, [floor], generateEnemies);
    currentLevel = level1;

    // Main loop
    var intervalID = setInterval(function() {
      canvas.clear().fill('#17E');
      //tiledBackground.draw(canvas, 0, 0);

      level1.step();

      drawOverlay();

      // GG
      if (dino.health() <= 0) {
        clearInterval(intervalID);
        dialogBox.draw(canvas);
        $('audio').remove();
      }
    }, 33);
  }});
  </script>

</body>
</html>
