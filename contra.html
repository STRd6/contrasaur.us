<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>contra</title>
  <meta name="generator" content="TextMate http://macromates.com/">
  <meta name="author" content="Matthew Diebolt">
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
  <script src="power_canvas.jquery.js"></script>
  <script src="sprites.strd6.js"></script>
  <script src="base.js"></script>
  <script src="UI.js"></script>
  <script src="util.js"></script>

  <!-- Date: 2010-05-08 -->
</head>
<body>

  <canvas id="gameCanvas" width="640" height="480">
    <p> Get a better browser</p>
  </canvas>

  <audio src="Dragon Force - My Spirit Will Go On.mp3" autoplay="true" controls="controls">
    Your browser does not support the audio element.
  </audio>

  <script>
  var score = 0;
  var enemyBullets = [];
  var bullets = [];
  var enemies = [];
  var canvas;
  var dino;
  var floor;
  var bulletTile = loadImageTile("blast_small.png");
  var dinoTile = loadImageTile("dino1.png");
  var tankTile = loadImageTile("tank.png");
  
  function display(text) {
    enemies.push(GameText(text, dino.boundingBox()));
  }

  $('#gameCanvas').powerCanvas({init: function(_canvas) {
    canvas = _canvas; 

    var gameObjects = [Dinosaur(), Floor()]; 

    dino = gameObjects[0];
    floor = gameObjects[1];
    
    var backgrounds = [
      {
        image: loadImageTile("clouds2.png"),
        rate: -0.5,
        position: 0
      },
      {
        image: loadImageTile("clouds1.png"),
        rate: -1,
        position: 0
      }
    ];

    var foregrounds = [
      {
        image: loadImageTile('jungleTree.png', function(tile) { 
          foregrounds[0].y = rand(floor.boundingBox().height - 10) + 10 + canvas.height() - floor.boundingBox().height -  tile.height;
        }),
        rate: 0,
        position: rand(240)
      },
      {
        image: loadImageTile('jungleTree.png', function(tile) { 
          foregrounds[1].y = rand(floor.boundingBox().height - 10) + 10 + canvas.height() - floor.boundingBox().height -  tile.height;
        }),
        rate: 0,
        position: rand(240)
      }
    ];
    
    var healthBar = ProgressBar({
      colorMap: function colorMap(completeness) {
        var r = Math.floor(Math.clamp(1.5 - 2 * completeness, 0, 1) * 255).toString(16);
        if(r.length == 1) {
          r = "0" + r;
        }
        
        var g = Math.floor(Math.clamp(completeness * 0.75, 0, 1) * 255).toString(16);
        if(g.length == 1) {
          g = "0" + g;
        }
        
        return "#" + r + g + "00";
      },
      max: dino.health(),
      value: dino.health(),
      x: 50,
      y: 4,
      width: 100,
      height: 14
    });

    var intervalID = setInterval(function() {
      canvas.clear().fill('#17E');
      //tiledBackground.draw(canvas, 0, 0);

      // Draw Backgrounds
      $.each(backgrounds, function(i, background) {
        var offset = canvas.width();
        if(background.position > 0) {
          offset = -offset;
        }

        background.image.draw(canvas, background.position, 0);
        background.image.draw(canvas, background.position + offset, 0);
        background.position = (background.position + background.rate) % canvas.width();
      });

      // Gather Input

      if (Math.random() < .03) {
        enemies.push(Enemy());
      }

      if (Math.random() < .01) {
        enemies.push(Tank({sprite: tankTile}));
      }
      
      if (Math.random() < 0.01) {
        // HAX: Putting this in enemy bullets so it will collide with dino.
        enemyBullets.push(PowerUp({
          x: rand(canvas.width()),
          yVelocity: 2
        }));
      }

      collision(dino,floor);

      $.each(enemies, function(i, enemy) {
        collision(dino, enemy);

      });

      $.each(enemies, function(i, enemy) {
        collision(floor, enemy);
      });
      
      $.each(gameObjects, function(i, gameObject) {
        gameObject.update();
        
        if (gameObject.active()) {
          gameObject.draw(canvas);
        }
      });

      var liveEnemies = [];

      $.each(enemies, function(i, enemy) {
        enemy.update();

        $.each(bullets, function(i, bullet) {
          collision(bullet, enemy);
        });

        if (enemy.active()) {
          liveEnemies.push(enemy);
          enemy.draw(canvas);
        } else {
          score += enemy.pointsWorth();
        }
      });
      enemies = liveEnemies;

      var liveBullets = [];
      var liveEnemyBullets = [];

      $.each(bullets, function(i, bullet) {
        bullet.update();
        if (bullet.active()) {
          bullet.draw(canvas);
          liveBullets.push(bullet);
        }
      });
      bullets = liveBullets;

      $.each(enemyBullets, function(i, bullet) {
        collision(bullet, dino);
        bullet.update();
        if (bullet.active()) {
          bullet.draw(canvas);
          liveEnemyBullets.push(bullet);
        }
      });
      enemyBullets = liveEnemyBullets;
      
      // Draw Foregrounds
      $.each(foregrounds, function(i, foreground) {
        var offset = canvas.width();
        
        if(foreground.position > 0) {
          offset = -offset;
        }

        foreground.image.draw(canvas, foreground.position, foreground.y);
        foreground.image.draw(canvas, foreground.position + offset, foreground.y);
        foreground.position = (foreground.position + foreground.rate) % canvas.width();
      });
      
      score += bullets.length;
      
      healthBar.value(dino.health());
      healthBar.draw(canvas);

      canvas.fillColor("#000");
      canvas.fillText("Health: ", 10, 14);

      // Score display
      canvas.fillText("Score: " + score, 225, 14);

      // GG
      if (dino.health() <= 0) {
        clearInterval(intervalID);
        canvas.fillText("GG", 140, 140);
      }
    }, 33);
  }});
  </script>

</body>
</html>
